$$$# Описание таблиц базы данных

Документ описывает назначение полей ключевых таблиц приложения и ссылается на места в коде, где эти данные используются.

## club_requests

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ заявки на вступление в клуб. | Используется Eloquent-моделью `ClubRequest` для идентификации записей. |
| `user_id` | Ссылка на пользователя, отправившего заявку. | Устанавливается при создании заявки (`ClubMembershipController::requestJoin()`), а также используется связью `ClubRequest::user()` и методом `User::clubRequests()` для выборок заявителя. |
| `club_id` | Идентификатор клуба, куда подана заявка. | Заполняется контроллером `ClubMembershipController`, используется отношением `ClubRequest::club()` и методами `Club::joinRequests()`/`pendingJoinRequests()` для получения заявок по клубу. |
| `status` | Статус заявки (`pending`, `approved`, `rejected`). | Задаётся при создании заявки и обновляется в методах `approveRequest()` и `declineRequest()` контроллера `ClubMembershipController`; скоуп `ClubRequest::scopePending()` фильтрует ожидающие заявки. |
| `declined_at` | Время отклонения заявки. | Заполняется при отклонении заявки в `ClubMembershipController::declineRequest()` для фиксации момента отказа. |
| `message` | Сообщение, оставленное пользователем при подаче заявки. | Передаётся из формы во время `requestJoin()` и хранится для владельца клуба. |
| `created_at`/`updated_at` | Метки времени создания и обновления записи. | Используются фреймворком Laravel для отслеживания истории изменения заявки. |

## clubs

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ клуба. | Используется всеми связями и контроллерами для идентификации клуба. |
| `name` | Название клуба. | Заполняется формами создания/редактирования (`ClubController::store()`/`update()`), отображается в списках клубов и турниров. |
| `email` | Контактный email клуба (опционально). | Принимается из форм `ClubController`, может использоваться для обратной связи. |
| `logo` | Путь к логотипу клуба. | Обрабатывается методом `Club::saveImg()` при загрузке файлов и показывается в представлениях клуба. |
| `avatar` | Квадратный аватар клуба. | Аналогично `logo`, загружается и сохраняется через `Club::saveImg()` и используется в списках клубов. |
| `owner_id` | Ссылка на владельца клуба. | Проверяется в политике доступа (`ClubRequestPolicy`, `ClubController::update()`), а также через связь `Club::owner()`. |
| `country_id`/`city_id` | География клуба (опционально). | Используются связями `Club::country()` и `Club::city()`, а также формами `ClubController` для выбора расположения. |
| `description` | Краткое описание клуба. | Вводится в форме клуба и отображается на странице клуба. |
| `phone_number` | Контактный телефон. | Собирается в формах `ClubController` и может выводиться в шаблонах. |
| `website` | Ссылка на сайт клуба. | Принимается контроллером и хранится для контактной информации. |
| `created_at`/`updated_at` | Метки времени создания и обновления. | Заполняются автоматически, используются для сортировки и отображения истории. |

## countries

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ страны. | Применяется связями с клубами и пользователями. |
| `name` | Название страны. | Используется в селекторах стран (`Country::getCountrySelector()`) и отображается в формах. |
| `code` | Уникальный буквенный код страны. | Применяется для идентификации и ограничения уникальности, может использоваться в интеграциях. |
| `created_at`/`updated_at` | Метки времени. | Управляются автоматически Laravel. |

## events

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ события клуба/турнира. | Используется при генерации игр и привязке расписаний. |
| `club_id` | Клуб-организатор события. | Задаётся через связь `Event::club()` и контроллеры турниров, используется при фильтрации событий клуба. |
| `tournament_id` | Связанный турнир (опционально). | Позволяет группировать события в рамках турнира (`Event::tournament()`), активно используется мастером турниров. |
| `name` | Название события. | Вводится пользователями при создании и показывается в расписании. |
| `date_start`/`date_end` | Интервалы проведения события. | Управляются контроллером `TournamentPagesController`, используются для показа дат и планирования игр (`Event::getDateStartDisplayAttribute()`). |
| `description` | Текстовое описание. | Заполняется в формах и отображается участникам. |
| `logo` | Изображение события. | Загружается при настройке события для визуализации. |
| `games_quota` | Планируемое число игр на событие. | Хранится и используется при генерации расписания игр (`TournamentPagesController::storeSchedule()` и связанные методы). |
| `tables` | Количество игровых столов. | Определяет параллельные столы и участвует в распределении судей/игроков (`TournamentPagesController::syncGamesForEvent()`). |
| `created_at`/`updated_at` | Метки времени. | Управляются фреймворком для аудита. |

## game_participants

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ записи участника игры. | Используется для уникальной идентификации слотов. |
| `game_id` | Связь с конкретной игрой. | Через `GameParticipant::game()` и `Game::slots()` определяется принадлежность к партии. |
| `user_id` | Пользователь, занявший слот (может быть `NULL`). | Делается nullable для возможности резервирования места; связывается с игроком через `GameParticipant::user()` и формы управления составом. |
| `role` | Роль игрока (например, `mafia`, `citizen`). | Устанавливается контроллерами игр, используется при отображении ролей и подсчёте статистик турнира (`Tournament::getResultsTable()`). |
| `slot` | Позиция за столом. | Применяется для рассадки и логики протокола (`GamePagesController::host()` и методы генерации toasts). |
| `status` | Состояние игрока (жив, выбыл и т.д.). | Обновляется в контроллерах управления игрой и отображается в интерфейсах ведущего/стрима. |
| `win` | Флаг победы (`1`/`0`). | Вводится подсистемой подсчёта очков и суммируется в отчётах турнира (`Tournament::getResultsTable()`). |
| `score_base` | Базовый балл за победу команды игрока (1 — победа, 0 — поражение). | Устанавливается массово кнопкой `teamWin` в интерфейсе ведущего (`public/js/game-host.js`) и сохраняется через `GamePagesController::update()`, затем используется в агрегатах побед/поражений `Tournament::getResultsTable()`. |
| `score_1` | Штрафные очки (отрицательные значения уменьшают итог). | Ведущий вводит показатель в колонке «Штраф» формы результатов (`resources/views/games/parts/header.blade.php`, `resources/views/games/parts/score.blade.php`), контроллер `GamePagesController::update()` сохраняет изменение и сумма попадает в сводную таблицу турнира (`Tournament::getResultsTable()`). |
| `score_2` | Механические очки (фиксируют технические бонусы/штрафы, не связанные с оценкой судей). | Заполняется вручную в поле «Мех» формы протокола (`resources/views/games/parts/header.blade.php`, `resources/views/games/parts/score.blade.php`) и хранится `GamePagesController::update()` с последующим суммированием в отчётах турнира. |
| `score_3` | Дополнительные очки, автоматически рассчитанные из выставленных ведущим отметок по мафиози. | Выпадающий список меток `mark` на форме вызывает JS-функцию `mechPoints`, которая через `/marks-calc` возвращает рассчитанные значения и подставляет их в `score_3` (`public/js/game-host.js`), после чего `GamePagesController::update()` сохраняет результат и он учитывается в `Tournament::getResultsTable()`. |
| `score_4` | Бонус «Лучший ход» за угадывание команды жертвы первой ночи. | Метод `GamePagesController::bestGuess()` при попадании минимум двумя выборками мафии обнуляет колонку для всех участников и начисляет жертве 0.3 или 0.5 балла, которые затем суммируются в итоговом отчёте турнира. |
| `score_5` | Компенсационные очки (колонка «CI») для сохранения корректировок, не влияющих на мгновенный пересчёт. | Поле присутствует в скрытой колонке формы результатов (`resources/views/games/parts/header.blade.php`, `resources/views/games/parts/score.blade.php`), обрабатывается `GamePagesController::update()` и суммируется в `Tournament::getResultsTable()` для дальнейших аналитических отчётов. |
| `score_total` | Финальный балл участника за игру. | JS на странице ведущего автоматически пересчитывает итог как сумму `score_base + score_1 + score_2 + score_3 + score_4` при изменении входных полей (`public/js/game-host.js`), после чего `GamePagesController::update()` сохраняет показатель и он используется для сортировки результатов (`Tournament::getResultsTable()`). |
| `score_count_flag` | Флаг учета очков в глобальной статистике (`'0'` — не учтены, `'1'` — учтены). | По умолчанию `'0'`. При подсчете результатов турнира через кнопку "Посчитать результаты" (`TournamentController::calculateScores()`) сервис `TournamentScoreService` обрабатывает только записи со значением `'0'`, добавляя их `score_total` к `users.glob_score`, после чего устанавливает флаг в `'1'`. Это предотвращает повторный учет одних и тех же результатов при многократных пересчетах. Используется в запросах с условием `WHERE score_count_flag='0'` для фильтрации необработанных игр. |
| `mark`/`mark_number` | Судейская отметка и числовое значение. | Используются для отображения оценки игрока и расчётов (`GamePagesController::host()` учитывает их при показе слота). |
| `warns` | Количество предупреждений. | Управляется при ведении игры (например, через `GamePagesController`) и отображается на панели ведущего и стрима. |
| `created_at`/`updated_at` | Метки времени. | Позволяют отслеживать изменения записей участника. |

## games

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ игры. | Используется во всех связях и при формировании протоколов. |
| `code` | Короткий код игры. | Генерируется для ссылок и идентификации (например, при подключении к трансляции). |
| `event_id` | Ссылка на событие, частью которого является игра. | Через `Game::event()` связывает игру с расписанием событий. |
| `name` | Название или номер игры. | Отображается в интерфейсах планирования и просмотра. |
| `date` | Запланированное время игры. | Используется для календаря и трансляций; приводится к `datetime` в `Game::$casts`. |
| `start`/`end` | Фактическое время начала и окончания. | Обновляются во время проведения партии и позволяют строить статистику по длительности. |
| `description` | Примечания к игре. | Может хранить сценарий или дополнительные сведения. |
| `props` | JSON-структура с состоянием игры. | Контроллер ведущего `GamePagesController::host()` и API трансляции `streamState()` читают и дополняют `props`, чтобы держать текущие фазы, день, списки номинаций и выбывших, а также настройки стрима (`stream-key`, отображение ролей) в актуальном виде. Методы модели `Game::slotsInit()` и `Game::getToasts()` используют те же данные для инициализации слотов и построения уведомлений, а `Tournament::getResultsTable()` извлекает из JSON признаки вроде "первого убийства" при построении статистики. |
| `protocol` | JSON-протокол игры. | Поле валидируется при создании/обновлении записи (`GameController::store()`/`update()`) и приводится к массиву в `Game::$casts`, чтобы хранить сериализованный протокол партии и отдавать его сервисам, которые формируют итоговые отчёты или внешние выгрузки. |
| `judge_id` | Судья, назначенный на игру. | Через связь `Game::judge()` и аксессор `getJudgeTypeAttribute()` поле связывает игру с конкретным судьёй турнира и его типом, а метод `TournamentPagesController::syncGamesForEvent()` автоматически проставляет `judge_id` при генерации расписания столов; `User::judgeGames()` позволяет получать список игр, где пользователь выступает судьёй. |
| `table` | Номер стола. | Применяется при генерации сетки игр по столам. |
| `created_at`/`updated_at` | Метки времени. | Управляются Laravel для аудита. |

## request_status_history

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ записи истории. | Используется для идентификации события изменения статуса. |
| `request_id` | Ссылка на заявку (`requests`). | Заполняется методом `Request::logStatusChange()` при любом изменении статуса. |
| `status` | Новый статус заявки. | Фиксирует состояние в момент изменения и показывается в истории. |
| `actor_id` | Пользователь, изменивший статус (может быть `NULL`). | Передаётся из логики обработки заявок (например, при одобрении заявки турнира ответственным). |
| `notes` | Дополнительные заметки. | Заполняется при логировании статуса для хранения сообщения о действии. |
| `created_at`/`updated_at` | Метки времени. | Отражают хронологию изменений заявок. |

## request_types

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ типа заявки. | Нужен для внешних ключей таблицы `requests`. |
| `slug` | Уникальный код типа. | Используется для поиска нужного типа (например, `tournament_join` в `TournamentPagesController`). |
| `name` | Человекочитаемое название. | Показывается в админских списках и формах (`RequestTypeController`). |
| `config` | JSON с дополнительной конфигурацией. | Кастится в массив (`RequestType::$casts`) и используется для хранения метаданных типа; при создании типо логия может ссылаться на модель-цель (`RequestType::TYPES`). |
| `created_at`/`updated_at` | Метки времени. | Управляются Laravel и используются в интерфейсе администратора. |

## requests

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ заявки. | Используется при обработке и отображении. |
| `type_id` | Ссылка на тип заявки (`request_types`). | Через `Request::type()` определяет бизнес-логику (например, заявки на участие в турнире). |
| `applicant_id` | Пользователь-заявитель. | Связь `Request::applicant()` и проверки в контроллерах используют это поле. |
| `target_type`/`target_id` | Полиморфная ссылка на объект, к которому относится заявка. | Реализует `morphTo` в `Request::target()` и позволяет одной таблице обслуживать заявки на турниры, события и т.д. |
| `status` | Текущее состояние (`pending`, `accepted`, `declined`, `canceled`, `expired`). | Меняется методами `Request::accept()` и обработчиками в `TournamentPagesController` при одобрении/отклонении заявок. |
| `responder_id` | Пользователь, принявший решение по заявке. | Заполняется при обработке заявки (например, организатором турнира). |
| `responded_at` | Время ответа. | Устанавливается при одобрении/отклонении заявки и используется для журналирования. |
| `response_note` | Комментарий ответственного. | Сохраняется при вызове `Request::accept()` или других сценариях для фиксации причины решения. |
| `data` | Дополнительные данные заявки в формате JSON. | Хранит произвольные сведения (сообщения, отметки времени) и активно используется при обработке заявок на турнир (`TournamentPagesController::applicationApprove()`/`Decline()`). |
| `created_at`/`updated_at` | Метки времени. | Управляются автоматически. |
| `deleted_at` | Поле soft-delete. | Используется трейт `SoftDeletes` в модели `Request` для архивирования заявок без физического удаления. |

## tournament_couples

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ запрещённой пары. | Используется при обновлении и удалении записей. |
| `tournament_id` | Турнир, в котором пара не допускается. | Определяет принадлежность через `TournamentCouple::tournament()` и методы `Tournament::forbiddenCouples()`. |
| `user1_id`/`user2_id` | Игроки, которые не должны встречаться вместе. | Используются при создании/проверке пар (`Tournament::isForbiddenCouple()`, `TournamentPagesController::saveCouples()`). |
| `reason` | Причина запрета (опционально). | Позволяет организаторам фиксировать пояснение при добавлении пары. |
| `created_at`/`updated_at` | Метки времени. | Позволяют отслеживать историю добавления/изменения запретов. |

## tournament_judges

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ записи судьи турнира. | Используется при управлении составом судей. |
| `tournament_id` | Турнир, к которому назначен судья. | Связь `TournamentJudges::tournament()` и `Tournament::judges()` используют это поле. |
| `user_id` | Пользователь-судья. | Привязан через `TournamentJudges::user()` и участвует в распределении по играм. |
| `type` | Тип судьи (`judge`, `principal_judge`, `side_judge`). | Определяет роль судьи при назначении на столы (`TournamentPagesController::syncGamesForEvent()` различает главный стол и остальные). |
| `created_at`/`updated_at` | Метки времени. | Хранят историю назначений. |

## tournament_participants

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ участника турнира. | Используется при управлении составом. |
| `tournament_id` | Турнир, в который записан игрок. | Связь `TournamentParticipant::tournament()` и методы `Tournament::participants()` опираются на это поле. |
| `user_id` | Игрок-участник. | Используется в контроллерах (`TournamentParticipantController`) и при проверке статуса пользователя (`Tournament::isParticipant()`). |
| `created_at`/`updated_at` | Метки времени. | Применяются для аудита и сортировки. |

## tournaments

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ турнира. | Используется во всех отношениях и контроллерах. |
| `club_id` | Клуб-организатор турнира. | Проверяется политиками доступа и задаётся при создании (`TournamentController::store()`). |
| `name` | Название турнира. | Отображается в списках/страницах турниров. |
| `location` | Место проведения. | Заполняется формами и выводится в карточке турнира (`Tournament::getTournamentInfo()`). |
| `date_start`/`date_end` | Даты начала и окончания. | Валидация и вычисление `duration` происходит в `TournamentController`; используются при показе информации. |
| `duration` | Расчётная длительность в днях. | Пересчитывается при сохранении турнира и отображается пользователям (`Tournament::getTournamentInfo()`). |
| `logo` | Изображение турнира. | Загружается при создании/редактировании (`TournamentController`) и показывается в интерфейсе. |
| `banner` | Баннер турнира. | Используется при загрузке медиафайлов и отображении рекламных материалов (`TournamentController`). |
| `stream_banner` | Баннер трансляции. | Служит для оформления страниц стрима и хранится вместе с данными турнира. |
| `description` | Текстовое описание турнира. | Показывается участникам и организаторам. |
| `quota` | Общая квота участников. | Определяет лимиты и используется при настройке событий/расписания. |
| `players_quota` | Квота игроков. | Используется при расчёте количества столов и игр (`TournamentPagesController` вычисляет `tables`). |
| `games_quota` | Плановое количество игр. | Применяется при генерации расписания событий и игр турнира. |
| `prize` | Призовой фонд. | Заполняется в формах и отображается на странице турнира. |
| `participation_fee` | Взнос за участие. | Показывается в информации о турнире и участвует в расчётах бюджета. |
| `phase` | Текущая фаза турнира (см. `Tournament::PHASES`). | Используется для статуса турнира в интерфейсах и логике доступа. |
| `created_at`/`updated_at` | Метки времени. | Управляются Laravel для учёта истории турнира. |

## users

| Поле | Описание | Использование |
| --- | --- | --- |
| `id` | Первичный ключ пользователя. | Используется во всех связях и контроллерах для идентификации игрока. |
| `name` | Имя пользователя (логин). | Отображается в списках игроков, турниров и игр. Используется для аутентификации. |
| `email` | Email пользователя. | Применяется для аутентификации, уникален в системе. Используется для отправки уведомлений и восстановления пароля. |
| `password` | Хешированный пароль. | Используется при аутентификации через `AuthController`, хешируется через `Hash::make()`. |
| `avatar` | Путь к аватару пользователя. | Загружается через `User::saveAvatar()`, отображается в профиле и списках (`PlayerPagesController::index()`). |
| `first_name`/`last_name` | Имя и фамилия игрока. | Заполняются в профиле пользователя и отображаются в детальной информации. |
| `country_id`/`city_id` | География пользователя. | Связи `User::country()` и `User::city()` используются для отображения локации в профиле и списках. |
| `club_id` | Текущий клуб игрока. | Связь `User::club()` определяет основной клуб пользователя, используется в фильтрах и отображении (`User::getPlayerInfo()`). |
| `phone_number` | Контактный телефон. | Хранится в профиле для связи с игроком. |
| `telegram` | Telegram username. | Используется для связи и уведомлений. |
| `is_active` | Флаг активации аккаунта. | Проверяется при верификации email (`AuthController`), влияет на доступ к системе. |
| `email_verified_at` | Время верификации email. | Устанавливается при подтверждении email через токен верификации. |
| `glob_score` | Глобальный рейтинг игрока (суммарные очки по всем турнирам). | Обновляется через `TournamentScoreService::calculateScoresForTournament()` при подсчете результатов турнира. Значения добавляются (не перезаписываются) при каждом подсчете, если `score_count_flag=0`. Используется для сортировки игроков на странице `/players` (`PlayerPagesController::index()`) и подсчета рейтинга клубов (сумма `glob_score` всех участников в `ClubController::index()`). |
| `glob_games` | Общее количество игр игрока по всем турнирам. | Увеличивается при подсчете результатов турнира (`TournamentScoreService`). Считается количество уникальных игр (`COUNT(DISTINCT game_id)`), где участвовал игрок и `score_count_flag=0`. Отображается в профиле игрока и статистике (`User::getPlayerInfo()`). |
| `glob_tournaments` | Количество турниров, в которых участвовал игрок. | Обновляется при подсчете очков турнира (`TournamentScoreService`). Считается количество уникальных турниров (`COUNT(DISTINCT tournament_id)`), где `score_count_flag=0`. Используется для отображения общей статистики игрока. |
| `google_id`/`facebook_id` | ID пользователя в социальных сетях. | Используются для OAuth-аутентификации через `AuthController::handleGoogleCallback()` и `handleFacebookCallback()`. |
| `created_at`/`updated_at` | Метки времени создания и обновления. | Управляются Laravel, используются для сортировки и аудита. |

